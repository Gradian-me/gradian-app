services:
  gradian-app:
    image: ${CI_REGISTRY_IMAGE}:latest
    container_name: gradian-app
    restart: unless-stopped
    ports:
      - '8502:8502' # Host port 9501 maps to container port 8502
    volumes:
      # Optional: Mount logs directory if you want to persist logs
      - ./logs:/app/logs
    networks:
      - gradian-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8502/api/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    environment:
      - NODE_ENV=production
      - PORT=8502
      - HOSTNAME=0.0.0.0
      - AVALAI_API_KEY=${AVALAI_API_KEY}
      - CLIENT_ID=${CLIENT_ID}
      - JWT_SECRET=${JWT_SECRET}
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      - NEXTAUTH_URL=${NEXTAUTH_URL}
      - NEXT_PUBLIC_CLIENT_ID=${NEXT_PUBLIC_CLIENT_ID}
      - NEXT_PUBLIC_ENCRYPTION_KEY=${NEXT_PUBLIC_ENCRYPTION_KEY}
      - NEXT_PUBLIC_SCHEMA_API_BASE=${NEXT_PUBLIC_SCHEMA_API_BASE}
      - NEXT_PUBLIC_SECRET_KEY=${NEXT_PUBLIC_SECRET_KEY}
      - NEXT_PUBLIC_URL_DATA_CRUD=${NEXT_PUBLIC_URL_DATA_CRUD}
      - NEXT_PUBLIC_URL_SCHEMA_CRUD=${NEXT_PUBLIC_URL_SCHEMA_CRUD}
      - NEXT_PUBLIC_URL_SYNC_MAIL_TEMPLATE=${NEXT_PUBLIC_URL_SYNC_MAIL_TEMPLATE}
      - PEPPER=${PEPPER}
      - SECRET_KEY=${SECRET_KEY}
      - APP_ID=${APP_ID}
      - URL_DATA_CRUD=${URL_DATA_CRUD}
      - URL_SCHEMA_CRUD=${URL_SCHEMA_CRUD}
      - URL_SEND_EMAIL=${URL_SEND_EMAIL}
      - URL_SYNC_MAIL_TEMPLATE=${URL_SYNC_MAIL_TEMPLATE}
      - URL_AUTHENTICATION=${URL_AUTHENTICATION}
      - APP_SECRET_KEY=${APP_SECRET_KEY}
      - CAN_SET_DEMO_MODE=${CAN_SET_DEMO_MODE}
      - NEXT_PUBLIC_SKIP_KEY=${NEXT_PUBLIC_SKIP_KEY}
      - REQUIRE_LOGIN=${REQUIRE_LOGIN}
      - INTERNAL_API_BASE_URL=${INTERNAL_API_BASE_URL}
      - ENABLE_LOGGING=${ENABLE_LOGGING}
      - NEXT_PUBLIC_ENABLE_LOGGING=${NEXT_PUBLIC_ENABLE_LOGGING}

networks:
  gradian-network:
    external: true

