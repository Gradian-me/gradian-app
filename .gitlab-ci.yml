stages:
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  CINNAGEN_REGISTRY: "reg.cinnagen.com:8083"

before_script:
  - echo "üîê Ensuring clean Docker auth..."
  - docker logout "$CI_REGISTRY" || true
  - docker logout "$CINNAGEN_REGISTRY" || true
  - echo "üîê Authenticating with Cinnagen Docker Registry..."
  - |
    if [ -n "$CINNAGEN_REGISTRY_USER" ] && [ -n "$CINNAGEN_REGISTRY_PASSWORD" ]; then
      echo "$CINNAGEN_REGISTRY_PASSWORD" | docker login -u "$CINNAGEN_REGISTRY_USER" --password-stdin "$CINNAGEN_REGISTRY"
    else
      echo "‚ö†Ô∏è CINNAGEN_REGISTRY_USER or CINNAGEN_REGISTRY_PASSWORD not set, attempting unauthenticated pull..."
    fi
  - echo "üîê Authenticating with GitLab Docker Registry..."
  - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
  - echo "‚öôÔ∏è Setting up environment files..."
  - |
    cat > .env << EOF
    AVALAI_API_KEY=$AVALAI_API_KEY
    APP_ID=$APP_ID
    URL_AUTHENTICATION=$URL_AUTHENTICATION
    APP_SECRET_KEY=$APP_SECRET_KEY
    CLIENT_ID=$CLIENT_ID
    DATABASE_URL=$DATABASE_URL
    JWT_SECRET=$JWT_SECRET
    NEXTAUTH_SECRET=$NEXTAUTH_SECRET
    NEXTAUTH_URL=$NEXTAUTH_URL
    NEXT_PUBLIC_CLIENT_ID=$NEXT_PUBLIC_CLIENT_ID
    NEXT_PUBLIC_ENCRYPTION_KEY=$NEXT_PUBLIC_ENCRYPTION_KEY
    NEXT_PUBLIC_SCHEMA_API_BASE=$NEXT_PUBLIC_SCHEMA_API_BASE
    NEXT_PUBLIC_SECRET_KEY=$NEXT_PUBLIC_SECRET_KEY
    NEXT_PUBLIC_URL_DATA_CRUD=$NEXT_PUBLIC_URL_DATA_CRUD
    NEXT_PUBLIC_URL_SCHEMA_CRUD=$NEXT_PUBLIC_URL_SCHEMA_CRUD
    NEXT_PUBLIC_URL_SYNC_MAIL_TEMPLATE=$NEXT_PUBLIC_URL_SYNC_MAIL_TEMPLATE
    PEPPER=$PEPPER
    SECRET_KEY=$SECRET_KEY
    URL_DATA_CRUD=$URL_DATA_CRUD
    URL_SCHEMA_CRUD=$URL_SCHEMA_CRUD
    URL_SEND_EMAIL=$URL_SEND_EMAIL
    URL_SYNC_MAIL_TEMPLATE=$URL_SYNC_MAIL_TEMPLATE
    DEMO_MODE=$DEMO_MODE
    NEXT_PUBLIC_SKIP_KEY=$NEXT_PUBLIC_SKIP_KEY
    REQUIRE_LOGIN=$REQUIRE_LOGIN
    INTERNAL_API_BASE_URL=$INTERNAL_API_BASE_URL
    ENABLE_LOGGING=${ENABLE_LOGGING:-false}
    NEXT_PUBLIC_ENABLE_LOGGING=${NEXT_PUBLIC_ENABLE_LOGGING:-false}
    EOF

build:
  stage: build
  retry: 2
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"'
      when: manual
    - when: never
  tags:
    - CG-GR-APP-DEV
  script:
    - echo "üîç Checking Docker configuration..."
    - docker info | grep -i "registry\|mirror" || echo "No registry mirror configured"
    - echo "üì• Pulling base image from Cinnagen registry ($CINNAGEN_REGISTRY)..."
    - |
      if docker pull "$CINNAGEN_REGISTRY/node:25.2.1-slim"; then
        echo "‚úÖ Successfully pulled base image from Cinnagen registry"
      else
        echo "‚ùå Failed to pull base image from Cinnagen registry ($CINNAGEN_REGISTRY)"
        echo "   Please ensure the image exists at $CINNAGEN_REGISTRY/node:25.2.1-slim"
        exit 1
      fi
    - echo "üöÄ Building Docker image..."
    - SHORT_SHA=${CI_COMMIT_SHA:0:8}
    - export DOCKER_BUILDKIT=1
    - docker build --tag="$CI_REGISTRY_IMAGE:latest" --tag="$CI_REGISTRY_IMAGE:$SHORT_SHA" --build-arg NODE_ENV=$NODE_ENV --build-arg NEXT_PUBLIC_ENCRYPTION_KEY=$NEXT_PUBLIC_ENCRYPTION_KEY --build-arg NEXT_PUBLIC_SKIP_KEY=$NEXT_PUBLIC_SKIP_KEY .
    - docker push "$CI_REGISTRY_IMAGE:latest"
    - docker push "$CI_REGISTRY_IMAGE:$SHORT_SHA"
    - echo "üßπ Cleaning Docker after build..."
    - docker system prune -af
    - docker volume prune -f

deploy_staging:
  stage: deploy
  retry: 2
  needs:
    - job: build
      optional: true
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"'
    - when: never
  tags:
    - CG-GR-APP-PRD-1
  script:
    - echo "üöÄ Deploying to staging..."
    # Backup current container image (previous stable)
    - PREV_IMAGE=$(docker compose images -q app | head -n1) || true
    - docker ps -q > current_containers.txt || true
    - docker compose pull
    - docker compose down --remove-orphans || true
    # Attempt to start new containers
    - |
      if ! docker compose up -d; then
        echo "‚ùå Deployment failed. Rolling back to previous image..."
        if [ -n "$PREV_IMAGE" ]; then
          docker run -d --name app "$PREV_IMAGE"
        fi
        exit 1
      fi
    - sleep 10
    - docker compose ps
    - echo "üßπ Cleaning Docker after deploy..."
    - docker system prune -af
    - docker volume prune -f
  after_script:
    - rm -f current_containers.txt || true
  environment:
    name: staging
    url: https://scm.cinnagen.com/
